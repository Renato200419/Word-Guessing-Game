name: Package and Release

on:
  push:
    branches:
      - main
      - feature/deploy-and-version-management  # Agregar la rama actual
  pull_request:
    branches:
      - main
      - feature/deploy-and-version-management  # Agregar la rama actual

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v2  # Extrae el código fuente del repositorio

      - name: Set up Python
        uses: actions/setup-python@v2
        with:
          python-version: '3.8'  # Configura la versión de Python

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip  # Actualiza pip
          pip install setuptools wheel  # Instala dependencias necesarias para el empaquetado
          if [ -f "requirements.txt" ]; then pip install -r requirements.txt; fi

      - name: Build package
        run: |
          set -e  # Detener si ocurre cualquier error durante el empaquetado
          python setup.py sdist bdist_wheel || { echo "Fallo el empaquetado de setup.py. Verifique la configuración."; exit 1; }

      - name: List files in project directory
        run: |
          echo "Listando archivos en la raíz del proyecto..."
          ls -R .

      - name: List files in dist directory
        run: |
          echo "Verificando el contenido de la carpeta dist/..."
          ls -R dist || echo "La carpeta dist/ no se generó correctamente. Asegúrese de que el empaquetado se ejecute bien."

      - name: Create empty dist directory if not present
        run: |
          if [ ! -d "./dist" ]; then
            echo "dist/ directory does not exist. Creating it now and adding a placeholder file."
            mkdir dist
            touch dist/placeholder.txt
          fi

      - name: Create Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.TOKEN_GITHUB }}  # Token para autenticar la acción
        with:
          tag_name: v${{ github.run_number }}  # Crea un tag basado en el número de ejecución
          release_name: "Word Guessing Game - Release ${{ github.run_number }}"  # Nombre de la versión
          body: |
            ## Cambios en esta versión
            - Empaquetado del juego completo.
            - Añadido sistema de pistas limitadas.
            - Verificación de victoria y derrota con mensajes claros.
          draft: false  # Publica el release inmediatamente
          prerelease: false  # No es una versión preliminar

      - name: Upload Release Assets
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.TOKEN_GITHUB }}  # Token para autenticar la acción
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}  # URL para subir los archivos
          asset_path: ./dist/*  # Ruta de los archivos empaquetados
          asset_name: "word-guessing-game-v${{ github.run_number }}.tar.gz"  # Nombre del archivo a subir
          asset_content_type: application/gzip  # Tipo de contenido del archivo
